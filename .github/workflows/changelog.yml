name: Changelog

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: changelog-main
  cancel-in-progress: false

jobs:
  update-changelog:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Update changelog
      env:
        BEFORE_SHA: ${{ github.event.before }}
        AFTER_SHA: ${{ github.sha }}
        REPO: ${{ github.repository }}
      run: ./scripts/update-changelog.sh

    - name: Commit and push changelog
      run: |
        if git diff --quiet -- CHANGELOG.md; then
          echo "No changelog updates."
          exit 0
        fi

        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add CHANGELOG.md
        git commit -m "chore(changelog): update changelog [skip changelog]"
        git push
